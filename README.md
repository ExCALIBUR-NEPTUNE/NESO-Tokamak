# NESO-hw-impurity-transport
A NESO-based solver for modelling impurity transport in a plasma governed by the Hasegawa-Wakatani equations.

## Building
The easiest way to build the app is to use the [Spack package manager](https://spack.readthedocs.io/en/latest/index.html).
The build process has been tested with **Spack v0.19.0**; later versions may also work, but aren't recommended.

1. Install Spack v0.19.0, via the [official instructions](https://spack.readthedocs.io/en/latest/getting_started.html#installation).
On Debian-based systems (e.g. Ubuntu) the following should work:

```bash
# Ensure all prerequisites are installed
apt update
apt install -y build-essential ca-certificates coreutils curl environment-modules gfortran git gpg lsb-release python3 python3-distutils python3-venv unzip zip

git clone -c feature.manyFiles=true -b v0.19.0 https://github.com/spack/spack.git $HOME/.spack

# Modify .bashrc such that spack is always initialised in new shells
echo 'export SPACK_ROOT=$HOME/.spack' >> $HOME/.bashrc
echo 'source $SPACK_ROOT/share/spack/setup-env.sh' >> $HOME/.bashrc
export SPACK_ROOT=$HOME/.spack
source $SPACK_ROOT/share/spack/setup-env.sh
```

2. Next, having git-cloned this repository, change to the root directory (containing this readme) and obtain the required versions of NESO and its dependencies with:
```bash
git submodule update --init --recursive
```

3. The app can then be built with:
```bash
cd spack
spack env activate .
spack install -j <np>
cd -
```

where \<np\> is the number of parallel processes to use in the build.
Note that some of the dependencies (particularly nektar++) can take some time to install.

The solver executable will be generated in `spack-build-<hash>`, where `<hash`> is an 8 character hash generated by Spack.`

## Running examples
Configuration files for 2D and 3D examples (with and without impurity tracer particles) can be found in the `./examples` directory.
An easy way to run the examples is (from the top level of the repository):
```bash
# Load the mpich spack module
spack load mpich
# Set up and run an example via the helper script
./scripts/run_eg.sh [example_name]
```

- This will copy `./examples/[example_name]` to `./example-runs/[example_name]` and run the solver in that directory with 4 MPI processes by default.
- To run with a different number of MPI processes, use `<-n num_MPI> `
- The solver executable is assumed to be in the most recently modified `spack-build*` directory. To choose a different build location, use `<-b build_dir_path>`.

---